#!/bin/bash

# Credentials checker
if [ -z "${AWS_PROFILE}" ]; then
    echo -en "AWS_PROFILE variable unset"
    exit 1
fi

# Set your AWS_PROFILE using aws-profile
# List clusters if any
echo -en "Download EKS kubeconfig in $AWS_PROFILE\n"
read -p "Enter AWS region: " aws_region
echo -en "Available clusters: \n"
cluster_name=$(aws eks list-clusters --region "$aws_region" | jq -r '.clusters[]' | fzf)
echo -en "Fetching credentials for $cluster_name..."
aws eks update-kubeconfig --name "$cluster_name" --region "$aws_region" --dry-run > "$HOME"/.kube/"$cluster_name".config # without dry-run flag will fail
echo -en "\nCredentials saved in $HOME/.kube/$cluster_name.config"

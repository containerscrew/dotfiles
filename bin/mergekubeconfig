#! /usr/bin/env bash

# https://ahmet.im/blog/mastering-kubeconfig/

KUBECONFIG_DIR="${1:-$HOME/.kube}"

echo -e "\e[31mSelect kubeconfig files. Press 'Esc' to finish.\e[0m"
echo -e "\e[31mFinding configs in $KUBECONFIG_DIR.\e[0m"
sleep 2

kubeconfig_files=()

while true; do
    sleep 1
    config=$(find "$KUBECONFIG_DIR" -type f -name '*.config' | fzf)

    # Exit loop if no file is selected
    [ -z "$config" ] && break

    echo "Selected kubeconfig: $config"

    kubeconfig_files+=("$config")
done

KUBECONFIG=$(IFS=:; echo "${kubeconfig_files[*]}")
KUBECONFIG=$KUBECONFIG kubectl config view --merge --flatten >> "$KUBECONFIG_DIR"/config
echo -e "\e[32mConfiguration saved in $KUBECONFIG_DIR/config.\e[0m"
